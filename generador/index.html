<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Recuerdos - Optimizado</title>
    
    <link rel="stylesheet" href="style.css">

<script>
    (function() {
        const theme = localStorage.getItem('theme') || 
            (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    })();
</script>

</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen flex flex-col md:h-screen md:overflow-hidden transition-colors duration-200">

    <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 h-16 flex items-center justify-between px-4 md:px-6 flex-shrink-0 z-30 shadow-sm transition-colors duration-200 sticky top-0 md:relative">
        <div class="flex items-center gap-3 overflow-hidden">
            <button onclick="UI.toggleSidebar()" class="md:hidden text-gray-500 dark:text-gray-200 focus:outline-none" aria-label="Abrir menú">
                <svg class="icon-svg text-xl" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </button>
            
            <div class="w-8 h-8 bg-violet-600 rounded-lg flex items-center justify-center text-white shadow-md shadow-violet-200 dark:shadow-none flex-shrink-0">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            </div>
            <div class="flex items-center gap-2 truncate">
                <h1 class="font-bold text-lg text-gray-700 dark:text-gray-200 tracking-tight whitespace-nowrap">Gestor de Recuerdos</h1>
                <span id="breadcrumb-title" class="hidden sm:inline text-sm text-gray-400 dark:text-gray-500 font-medium truncate border-l border-gray-300 dark:border-gray-600 pl-2 ml-1"></span>
            </div>
        </div>
        <div class="flex gap-3 items-center flex-shrink-0">
            <button onclick="APP.toggleTheme()" class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" title="Cambiar tema" aria-label="Cambiar tema">
                <span id="theme-icon-container"></span>
            </button>
            
            <div id="header-actions" class="hidden flex gap-3">
                <button onclick="APP.exportData()" class="bg-gray-900 dark:bg-violet-700 hover:bg-black dark:hover:bg-violet-600 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-sm whitespace-nowrap">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm-1 14v-4h-3l4-4 4 4h-3v4h-2z"/></svg>
                    <span class="hidden sm:inline">Exportar</span>
                </button>
            </div>
        </div>
    </header>

    <div id="screen-home" class="flex-1 flex flex-col items-center justify-center p-6 fade-in">
        <div class="max-w-md w-full text-center space-y-8">
            <div class="space-y-2">
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Bienvenido</h2>
                <p class="text-gray-500 dark:text-gray-400">Todo listo para crear tus códigos.</p>
            </div>
            
            <div class="grid gap-4">
                <button onclick="APP.initEmpty()" class="group relative flex items-center justify-center p-6 bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700 hover:border-violet-100 dark:hover:border-violet-900 rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer text-left w-full">
                    <div class="flex flex-col items-center gap-3">
                        <div class="w-12 h-12 bg-violet-50 dark:bg-violet-900/30 text-violet-600 dark:text-violet-400 rounded-full flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        </div>
                        <span class="font-medium text-gray-700 dark:text-gray-200">Crear desde cero</span>
                    </div>
                </button>

                <div class="relative">
                    <input type="file" id="file-upload" accept=".js" class="hidden" onchange="APP.handleFileUpload(this)">
                    <button onclick="document.getElementById('file-upload').click()" class="w-full group relative flex items-center justify-center p-6 bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700 hover:border-violet-100 dark:hover:border-violet-900 rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer">
                        <div class="flex flex-col items-center gap-3">
                            <div class="w-12 h-12 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                            </div>
                            <span class="font-medium text-gray-700 dark:text-gray-200">Cargar data.js existente</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-editor" class="hidden flex-1 flex flex-col md:flex-row md:overflow-hidden fade-in relative">
        
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/40 hidden z-30 md:hidden backdrop-blur-sm transition-opacity" onclick="UI.toggleSidebar(false)"></div>

        <aside id="app-sidebar" class="fixed inset-y-0 left-0 w-[85%] transform -translate-x-full transition-transform duration-300 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col flex-shrink-0 z-40 md:static md:translate-x-0 md:w-80 shadow-2xl md:shadow-none h-full">
            <div class="p-4 border-b border-gray-100 dark:border-gray-700">
                <button onclick="APP.createNew(); UI.toggleSidebar(false);" class="w-full bg-violet-600 hover:bg-violet-700 text-white py-3 px-4 rounded-lg text-sm font-bold transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2 transform active:scale-95">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Nuevo Recuerdo
                </button>
            </div>
            
            <div id="message-list" class="flex-1 overflow-y-auto p-2 space-y-1 no-scrollbar bg-gray-50/50 dark:bg-gray-900/50">
            </div>
            
            <div class="p-3 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 text-xs text-center text-gray-400 dark:text-gray-500 font-medium transition-colors duration-200" id="counter-display">
                0 recuerdos
            </div>
        </aside>

        <main class="flex-1 bg-gray-50 dark:bg-gray-900 flex flex-col h-full relative transition-colors duration-200 px-0 md:px-0">
            
            <div id="editor-empty" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 dark:text-gray-500 p-8 select-none z-0">
                <div class="w-20 h-20 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4 text-gray-300 dark:text-gray-600 transition-colors duration-200">
                    <svg class="icon-svg text-3xl" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                </div>
                <p class="font-medium text-center">Selecciona un recuerdo o crea uno nuevo</p>
            </div>

            <div id="editor-form-container" class="hidden flex-col h-auto md:h-full w-full md:max-w-3xl mx-auto bg-white dark:bg-gray-800 md:shadow-lg md:border-x border-gray-200 dark:border-gray-700 transition-colors duration-200 z-10 relative">
                
                <div class="h-14 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between px-4 md:px-8 bg-white dark:bg-gray-800 flex-shrink-0 transition-colors duration-200 sticky top-16 md:static z-20">
                    <div class="flex items-center gap-2 text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> <span class="hidden xs:inline">Editando</span>
                    </div>
                    <button onclick="APP.requestDelete()" class="text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-1.5 rounded text-sm transition-colors flex items-center gap-2" title="Eliminar">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> <span class="hidden sm:inline">Eliminar</span>
                    </button>
                </div>

                <div class="flex-1 md:overflow-y-auto p-4 md:p-8 space-y-6 md:space-y-8 pb-20 md:pb-8">
                    
                    <div class="space-y-4">
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300">Nombre del recuerdo</label>
                        <input type="text" id="input-rawName" placeholder="Ej: Isla Corazón" 
                               class="w-full text-xl font-medium border-b-2 border-gray-200 dark:border-gray-600 focus:border-violet-500 bg-transparent py-2 px-1 transition-colors placeholder-gray-300 dark:placeholder-gray-600 text-gray-900 dark:text-white rounded-none"
                               autocomplete="off"
                               oninput="APP.syncStaticField('rawName', this.value)">
                        
                        <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-900 p-2.5 rounded border border-gray-100 dark:border-gray-700 transition-colors duration-200">
                            <svg class="icon-svg text-violet-400" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                            <span>ID:</span>
                            <code id="preview-id" class="text-violet-600 dark:text-violet-400 font-mono font-bold select-all break-all">...</code>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300">Tipo de experiencia</label>
                            <div class="relative">
                                <select id="input-type" onchange="APP.attemptTypeChange(this.value)" 
                                        class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 py-3 px-4 rounded-lg appearance-none cursor-pointer hover:border-violet-400 transition-colors focus:ring-2 focus:ring-violet-100 dark:focus:ring-violet-900 font-medium">
                                    <option value="text">Carta</option>
                                    <option value="image">Imagen</option>
                                    <option value="audio">Audio</option>
                                    <option value="image_audio">Imagen + Audio</option>
                                    <option value="video">Video YouTube</option>
                                    <option value="internal">Iframe</option>
                                    <option value="link">Enlace Web</option>
                                    <option value="download">Descarga</option>
                                </select>
                                <div class="absolute right-4 top-3.5 text-gray-400 pointer-events-none">
                                    <svg class="icon-svg text-xs" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300">Categoría</label>
                            <input type="text" id="input-categoria" placeholder="Ej: Carta, Regalo" 
                                   class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 py-3 px-4 rounded-lg focus:border-violet-500 focus:ring-2 focus:ring-violet-100 dark:focus:ring-violet-900 transition-all placeholder-gray-400 dark:placeholder-gray-500"
                                   oninput="APP.syncStaticField('categoria', this.value)">
                        </div>
                    </div>

                    <div id="dynamic-fields" class="space-y-6 border-t border-gray-100 dark:border-gray-700 pt-6 animate-pulse-short">
                    </div>

                    <div class="space-y-2 pt-2">
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300">Pista para desbloquear</label>
                        <div class="flex gap-3 items-start">
                            <div class="mt-3 text-yellow-500 text-lg">
                                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg>
                            </div>
                            <textarea id="input-pista" rows="2" placeholder="Escribe algo misterioso..." 
                                      class="w-full bg-yellow-50/50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 text-gray-700 dark:text-gray-200 py-3 px-4 rounded-lg resize-none focus:bg-white dark:focus:bg-gray-700 focus:border-yellow-400 transition-colors placeholder-gray-400 dark:placeholder-gray-500"
                                      oninput="APP.syncStaticField('pista', this.value)"></textarea>
                        </div>
                    </div>

                </div>

                <div class="p-4 md:p-6 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 flex flex-col md:flex-row justify-between items-center gap-4 flex-shrink-0 transition-colors duration-200 md:sticky md:bottom-0">
                    <span id="validation-msg" class="text-xs font-medium text-red-500 opacity-0 transition-opacity order-2 md:order-1 flex items-center gap-1">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        <span>Faltan datos requeridos</span>
                    </span>
                    <button id="btn-save" onclick="APP.saveDraft()" class="w-full md:w-auto bg-gray-900 dark:bg-violet-600 hover:bg-black dark:hover:bg-violet-700 text-white px-8 py-3 rounded-lg font-bold shadow-md shadow-gray-300 dark:shadow-none transition-all transform active:scale-95 flex items-center justify-center gap-2 order-1 md:order-2">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg> Guardar
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="generic-modal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4"
         role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-hidden="true" tabindex="-1">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-sm w-full p-6 transform transition-all scale-100 border border-gray-200 dark:border-gray-700">
            <div id="modal-icon-container" class="w-12 h-12 bg-orange-100 dark:bg-orange-900/30 text-orange-500 rounded-full flex items-center justify-center mb-4 text-xl mx-auto">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
            </div>
            <h3 id="modal-title" class="text-lg font-bold text-center text-gray-900 dark:text-white mb-2"></h3>
            <p id="modal-message" class="text-sm text-gray-500 dark:text-gray-400 text-center mb-6"></p>
            <div class="flex gap-3">
                <button id="modal-btn-cancel" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 font-medium transition-colors">
                    Cancelar
                </button>
                <button id="modal-btn-confirm" class="flex-1 px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-medium transition-colors">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <div id="toast-container" aria-live="polite" aria-atomic="true" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none px-4 md:px-0 w-full md:w-auto items-center md:items-end"></div>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <script>
        // --- 1. CONFIG & ICONS (SVG Strings) ---
        // Eliminada dependencia de FontAwesome
        const ICONS = {
            fileText: '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>',
            image: '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>',
            audio: '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>',
            video: '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>',
            download: '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/></svg>',
            check: '<svg class="icon-svg text-green-400" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',
            error: '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>',
            sun: '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.79 1.41-1.41-1.79-1.79-1.41 1.41zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.8-1.41-1.41-1.79 1.8z"/></svg>',
            moon: '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg>' // Using lightbulb/moon approx for demo
        };

        const PATHS = {
            AUDIO: "assets/unlocked_content/audio/",
            IMAGE: "assets/unlocked_content/images/",
            ENCRYPTED: "assets/unlocked_content/encrypted/",
            INTERNAL: ""
        };

        const DEFAULTS = {
            LOGROS: `export const logros = [
  { id: "primer_paso", codigo_requerido: 1, mensaje: "Hay muchos más esperándote." },
  { id: "cinco_secretos", codigo_requerido: 5, mensaje: "Eres una gran exploradora." },
  { id: "todos_los_secretos", codigo_requerido: "ALL_MESSAGES_LENGTH", mensaje: "¡Todos los secretos desbloqueados!." }
];`,
            HERRAMIENTAS: `export const herramientasExternas = [
  { nombre: "Desencriptar", descripcion: "Herramienta web.", url: "#", icono: "fas fa-key" }
];`
        };

        const UTILS = {
            normalizeId: (str) => {
                if (!str) return "";
                return str.toLowerCase()
                          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                          .replace(/\s+/g, "")
                          .replace(/[^a-z0-9]/g, "");
            },
            extractFilename: (fullPath) => fullPath ? fullPath.split('/').pop() : "",
            convertToEmbed: (url) => {
                if (!url) return "";
                const regExp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = url.match(regExp);
                return (match && match[1]) ? `https://www.youtube.com/embed/${match[1]}` : null;
            },
            showToast: (msg, type = 'success') => {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-500' : 'bg-gray-900 dark:bg-violet-600';
                el.className = `${colors} text-white px-5 py-3 rounded-lg shadow-lg text-sm font-medium fade-in pointer-events-auto flex items-center gap-3 transform transition-all w-full md:w-auto justify-center md:justify-start`;
                
                const iconSpan = document.createElement('span');
                iconSpan.innerHTML = type === 'error' ? ICONS.error : ICONS.check;
                
                const span = document.createElement('span');
                span.textContent = msg;

                el.appendChild(iconSpan);
                el.appendChild(span);

                container.appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(10px)';
                    setTimeout(() => el.remove(), 300);
                }, 3500);
            },
            escapeString: (str) => str ? str.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n') : "",
            unescapeString: (str) => str ? str.replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\') : ""
        };

        const STORE = {
            state: {
                mensajes: new Map(),
                rawLogros: DEFAULTS.LOGROS,
                rawHerramientas: DEFAULTS.HERRAMIENTAS
            },
            draft: null, 
            pendingTypeChange: null,
            modalCallback: null,

            init(mensajesObj = {}, rawLogros = null, rawHerramientas = null) {
                this.state.mensajes = new Map(Object.entries(mensajesObj));
                if (rawLogros) this.state.rawLogros = rawLogros;
                if (rawHerramientas) this.state.rawHerramientas = rawHerramientas;
                UI.renderList();
            },

            startDraft(id) {
                const msg = this.state.mensajes.get(id);
                const data = JSON.parse(JSON.stringify(msg));
                if (!data.rawName) data.rawName = id;
                this.draft = { originalId: id, data: data, isNew: false };
                UI.loadForm(this.draft.data);
            },

            createDraft() {
                this.draft = {
                    originalId: null,
                    data: {
                        rawName: "", type: "text", categoria: "", pista: "",
                        texto: "", audio: "", imagen: "", videoEmbed: "", archivo: "", link: "",
                        descarga: { url: "", nombre: "" }
                    },
                    isNew: true
                };
                UI.loadForm(this.draft.data);
            },

            saveDraft(finalData) {
                const newId = UTILS.normalizeId(finalData.rawName);
                if (!newId) return { success: false, msg: "El nombre no genera un ID válido" };

                if (newId !== this.draft.originalId && this.state.mensajes.has(newId)) {
                    return { success: false, msg: "Ya existe un recuerdo con un nombre similar" };
                }

                const cleanData = VALIDATOR.sanitize(finalData);

                if (!this.draft.isNew && this.draft.originalId && newId !== this.draft.originalId) {
                    this.state.mensajes.delete(this.draft.originalId);
                }

                this.state.mensajes.set(newId, cleanData);
                this.draft = null;
                UI.renderList();
                UI.selectItem(newId);
                return { success: true };
            },

            deleteMessage(id) {
                this.state.mensajes.delete(id);
                this.draft = null;
                UI.renderList();
                UI.hideForm();
            }
        };

        const VALIDATOR = {
            validate: (data) => {
                if (!data.rawName || !data.rawName.trim()) return { valid: false, msg: "El nombre es obligatorio.", field: 'input-rawName' };

                const t = data.type;
                
                if (t === 'text') {
                    if (!data.texto || !data.texto.trim()) return { valid: false, msg: "El texto no puede estar vacío.", field: 'f-texto' };
                }
                else if (t === 'image') {
                    if (!data.imagen) return { valid: false, msg: "Falta nombre de imagen.", field: 'f-imagen' };
                }
                else if (t === 'audio') {
                    if (!data.audio) return { valid: false, msg: "Falta nombre de audio.", field: 'f-audio' };
                }
                else if (t === 'image_audio') {
                    if (!data.imagen || !data.audio) return { valid: false, msg: "Se requiere imagen y audio.", field: 'f-imagen' };
                }
                else if (t === 'video') {
                    if (!data.videoEmbed) return { valid: false, msg: "Enlace YouTube inválido.", field: 'f-video' };
                }
                else if (t === 'internal') {
                    if (!data.archivo) return { valid: false, msg: "Falta ruta del archivo.", field: 'f-archivo' };
                }
                else if (t === 'link') {
                    if (!data.link) return { valid: false, msg: "URL inválida.", field: 'f-link' };
                }
                else if (t === 'download') {
                    if (!data.descarga || !data.descarga.nombre) return { valid: false, msg: "Falta nombre de archivo.", field: 'f-dl-nombre' };
                }

                return { valid: true };
            },

            sanitize: (data) => {
                const base = {
                    type: data.type,
                    categoria: data.categoria || "General",
                    pista: data.pista || "",
                    rawName: data.rawName
                };
                if (data.type === 'text') base.texto = data.texto;
                if (data.type === 'audio') base.audio = data.audio;
                if (data.type === 'image') base.imagen = data.imagen;
                if (data.type === 'image_audio') { base.audio = data.audio; base.imagen = data.imagen; }
                if (data.type === 'video') { base.texto = data.texto; base.videoEmbed = data.videoEmbed; }
                if (data.type === 'internal') base.archivo = data.archivo;
                if (data.type === 'link') base.link = data.link;
                if (data.type === 'download') base.descarga = data.descarga;
                return base;
            }
        };

        const IO = {
            parse: (content) => {
                try {
                    const mensajesRaw = content.match(/export const mensajes = ({[\s\S]*?});/);
                    const logrosRaw = content.match(/export const logros = (\[[\s\S]*?\]);/);
                    const herrRaw = content.match(/export const herramientasExternas = (\[[\s\S]*?\]);/);

                    if (!mensajesRaw) throw new Error("Formato inválido: Falta bloque mensajes");

                    const mensajesObj = {};
                    let rawBody = mensajesRaw[1].trim().substring(1, mensajesRaw[1].trim().length - 1);
                    
                    let remaining = rawBody;
                    let safety = 0;
                    while (remaining.length > 0 && safety < 1000) {
                        safety++;
                        const keyMatch = remaining.match(/^\s*"([^"]+)":\s*\{/);
                        if (!keyMatch) {
                            if (remaining.match(/^\s*,?\s*$/)) break;
                            remaining = remaining.substring(1); continue;
                        }
                        const key = keyMatch[1];
                        const startBrace = remaining.indexOf('{');
                        let balance = 0, endBrace = -1, inStr = false;
                        for (let i = startBrace; i < remaining.length; i++) {
                            if (remaining[i] === '"' && remaining[i-1] !== '\\') inStr = !inStr;
                            if (!inStr) {
                                if (remaining[i] === '{') balance++;
                                if (remaining[i] === '}') balance--;
                                if (balance === 0) { endBrace = i; break; }
                            }
                        }
                        if (endBrace === -1) break;

                        const block = remaining.substring(startBrace, endBrace + 1);
                        mensajesObj[key] = IO.parseBlock(block);
                        mensajesObj[key].rawName = key; 

                        remaining = remaining.substring(endBrace + 1).trim();
                        if (remaining.startsWith(',')) remaining = remaining.substring(1).trim();
                    }

                    return { mensajes: mensajesObj, logros: logrosRaw ? logrosRaw[0] : null, herramientas: herrRaw ? herrRaw[0] : null };
                } catch (e) {
                    console.error(e);
                    throw new Error("Archivo corrupto o ilegible.");
                }
            },
            parseBlock: (str) => {
                const props = {};
                const dlMatch = str.match(/descarga:\s*({[\s\S]*?})(,|$)/);
                if (dlMatch) {
                    const dlBody = dlMatch[1];
                    const url = (dlBody.match(/url:\s*"([^"]*)"/) || [])[1] || "";
                    const nom = (dlBody.match(/nombre:\s*"([^"]*)"/) || [])[1] || "";
                    props.descarga = { url, nombre: nom };
                    str = str.replace(dlMatch[0], "");
                }
                const regex = /([a-zA-Z0-9_]+):\s*"((?:[^"\\]|\\.)*)"/g;
                let m;
                while ((m = regex.exec(str)) !== null) props[m[1]] = UTILS.unescapeString(m[2]);
                return props;
            },
            serialize: () => {
                let js = `export const mensajes = {\n`;
                STORE.state.mensajes.forEach((msg, key) => {
                    js += `  "${key}": {\n    type: "${msg.type}",\n`;
                    if (msg.texto) js += `    texto: "${UTILS.escapeString(msg.texto)}",\n`;
                    if (msg.audio) js += `    audio: "${msg.audio}",\n`;
                    if (msg.imagen) js += `    imagen: "${msg.imagen}",\n`;
                    if (msg.videoEmbed) js += `    videoEmbed: "${msg.videoEmbed}",\n`;
                    if (msg.archivo) js += `    archivo: "${msg.archivo}",\n`;
                    if (msg.link) js += `    link: "${msg.link}",\n`;
                    if (msg.descarga) js += `    descarga: {\n      url: "${msg.descarga.url}",\n      nombre: "${msg.descarga.nombre}"\n    },\n`;
                    js += `    categoria: "${UTILS.escapeString(msg.categoria)}",\n    pista: "${UTILS.escapeString(msg.pista)}"\n  },\n`;
                });
                js += `};\n\n`;
                
                let log = STORE.state.rawLogros.trim();
                if (!log.startsWith('export')) log = `export const logros = ${log};`;
                let herr = STORE.state.rawHerramientas.trim();
                if (!herr.startsWith('export')) herr = `export const herramientasExternas = ${herr};`;
                return js + log + "\n\n" + herr;
            }
        };

        const UI = {
            els: {
                screenHome: document.getElementById('screen-home'),
                screenEditor: document.getElementById('screen-editor'),
                headerActions: document.getElementById('header-actions'),
                list: document.getElementById('message-list'),
                counter: document.getElementById('counter-display'),
                formContainer: document.getElementById('editor-form-container'),
                editorEmpty: document.getElementById('editor-empty'),
                dynamicFields: document.getElementById('dynamic-fields'),
                modal: document.getElementById('generic-modal'),
                inputRawName: document.getElementById('input-rawName'),
                previewId: document.getElementById('preview-id'),
                inputType: document.getElementById('input-type'),
                inputCat: document.getElementById('input-categoria'),
                inputPista: document.getElementById('input-pista'),
                msgError: document.getElementById('validation-msg'),
                sidebar: document.getElementById('app-sidebar'),
                overlay: document.getElementById('sidebar-overlay'),
                breadcrumb: document.getElementById('breadcrumb-title')
            },

            lastFocusedElement: null,

            toggleSidebar(forceState = null) {
                const isClosed = this.els.sidebar.classList.contains('-translate-x-full');
                const shouldOpen = forceState !== null ? forceState : isClosed;

                if (shouldOpen) {
                    this.els.sidebar.classList.remove('-translate-x-full');
                    this.els.overlay.classList.remove('hidden');
                } else {
                    this.els.sidebar.classList.add('-translate-x-full');
                    this.els.overlay.classList.add('hidden');
                }
            },

            showEditor() {
                this.els.screenHome.classList.add('hidden');
                this.els.screenEditor.classList.remove('hidden');
                this.els.screenEditor.classList.add('flex');
                this.els.headerActions.classList.remove('hidden');
            },

            renderList() {
                this.els.list.innerHTML = '';
                const messages = Array.from(STORE.state.mensajes.entries());
                this.els.counter.innerText = `${messages.length} recuerdos guardados`;

                messages.forEach(([id, msg]) => {
                    const el = document.createElement('div');
                    const isActive = STORE.draft && STORE.draft.originalId === id;
                    
                    let svgIcon = ICONS.fileText;
                    if (msg.type === 'image') svgIcon = ICONS.image;
                    if (msg.type === 'audio') svgIcon = ICONS.audio;
                    if (msg.type === 'video') svgIcon = ICONS.video;
                    if (msg.type === 'download') svgIcon = ICONS.download;

                    // UI MEJORA: Sombras reducidas y bordes suaves
                    const baseClass = "p-3 mx-2 rounded-lg cursor-pointer transition-all border border-transparent";
                    const activeClass = "bg-white dark:bg-gray-700 shadow-sm border-violet-100 dark:border-gray-600 ring-1 ring-violet-500 dark:ring-violet-400";
                    const inactiveClass = "hover:bg-white dark:hover:bg-gray-800 hover:shadow-sm";
                    
                    el.className = `${baseClass} ${isActive ? activeClass : inactiveClass}`;
                    
                    el.onclick = () => { 
                        APP.editMessage(id);
                        this.toggleSidebar(false);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    };
                    
                    const innerContainer = document.createElement('div');
                    innerContainer.className = "flex items-center gap-3";
                    
                    const iconContainer = document.createElement('div');
                    iconContainer.className = "w-8 h-8 rounded-lg bg-gray-50 dark:bg-gray-800 flex items-center justify-center flex-shrink-0 text-sm text-gray-400 dark:text-gray-500";
                    iconContainer.innerHTML = svgIcon;

                    const textContainer = document.createElement('div');
                    textContainer.className = "overflow-hidden flex-1";
                    
                    const titleEl = document.createElement('div');
                    titleEl.className = "font-bold text-gray-700 dark:text-gray-200 truncate text-sm";
                    titleEl.textContent = msg.rawName || id; 

                    const subEl = document.createElement('div');
                    // UI MEJORA: Contraste aumentado
                    subEl.className = "text-[10px] text-gray-400 dark:text-gray-400 font-mono";
                    subEl.textContent = `#${id}`;

                    textContainer.appendChild(titleEl);
                    textContainer.appendChild(subEl);
                    innerContainer.appendChild(iconContainer);
                    innerContainer.appendChild(textContainer);
                    el.appendChild(innerContainer);

                    this.els.list.appendChild(el);
                });
            },

            selectItem(id) { this.renderList(); },
            hideForm() { 
                this.els.formContainer.classList.remove('flex');
                this.els.formContainer.classList.add('hidden');
                this.els.editorEmpty.classList.remove('hidden');
                this.els.breadcrumb.textContent = "";
            },

            loadForm(data) {
                this.els.editorEmpty.classList.add('hidden');
                this.els.formContainer.classList.remove('hidden');
                this.els.formContainer.classList.add('flex');
                this.els.msgError.style.opacity = '0';

                this.els.inputRawName.value = data.rawName || "";
                this.els.previewId.innerText = UTILS.normalizeId(data.rawName) || "...";
                this.els.inputCat.value = data.categoria || "";
                this.els.inputPista.value = data.pista || "";
                this.els.inputType.value = data.type;
                
                // UX MEJORA: Breadcrumb dinámico
                this.els.breadcrumb.textContent = data.rawName ? ` > ${data.rawName}` : " > Nuevo";

                this.renderDynamicFields(data.type, data);
            },

            renderDynamicFields(type, data) {
                const container = this.els.dynamicFields;
                container.innerHTML = '';
                
                const createInput = (label, id, value, placeholder, help = "", isArea = false) => {
                    const wrap = document.createElement('div');
                    const inputClasses = "w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 p-3 rounded-lg focus:ring-2 focus:ring-violet-100 dark:focus:ring-violet-900 focus:border-violet-500 transition-colors placeholder-gray-400 dark:placeholder-gray-500";
                    
                    const inputHtml = isArea
                        ? `<textarea id="${id}" rows="5" class="${inputClasses}">${value || ''}</textarea>`
                        : `<input type="text" id="${id}" value="${value || ''}" placeholder="${placeholder}" class="${inputClasses}">`;
                    
                    wrap.className = "space-y-1";
                    wrap.innerHTML = `<label class="block text-sm font-bold text-gray-700 dark:text-gray-300">${label}</label>${help ? `<p class="text-xs text-gray-400 dark:text-gray-500 mb-2">${help}</p>` : ''}${inputHtml}`;
                    return wrap;
                };

                if (type === 'text') {
                    container.appendChild(createInput('Contenido', 'f-texto', data.texto, 'Escribe aquí...', '', true));
                }
                else if (type === 'audio') {
                    container.appendChild(createInput('Nombre archivo Audio', 'f-audio', UTILS.extractFilename(data.audio), 'ejemplo: audio.mp3', 'Solo nombre. Ruta automática.'));
                }
                else if (type === 'image') {
                    container.appendChild(createInput('Nombre archivo Imagen', 'f-imagen', UTILS.extractFilename(data.imagen), 'ejemplo: foto.jpg', 'Solo nombre. Ruta automática.'));
                }
                else if (type === 'image_audio') {
                    container.appendChild(createInput('Imagen', 'f-imagen', UTILS.extractFilename(data.imagen), 'foto.jpg'));
                    container.appendChild(createInput('Audio', 'f-audio', UTILS.extractFilename(data.audio), 'audio.mp3'));
                }
                else if (type === 'video') {
                    container.appendChild(createInput('Mensaje', 'f-texto', data.texto, 'Mensaje corto'));
                    container.appendChild(createInput('YouTube Link', 'f-video', data.videoEmbed, 'https://youtu.be/...', 'Convertimos el link automáticamente.'));
                }
                else if (type === 'internal') {
                    container.appendChild(createInput('Ruta Archivo', 'f-archivo', data.archivo, 'folder/index.html'));
                }
                else if (type === 'link') {
                    container.appendChild(createInput('Enlace', 'f-link', data.link, 'https://...'));
                }
                else if (type === 'download') {
                    container.appendChild(createInput('Nombre Archivo Secreto', 'f-dl-nombre', data.descarga ? data.descarga.nombre : "", 'archivo.zip'));
                }
            },

            getFullFormDataFromDOM() {
                const type = STORE.draft.data.type;
                const base = {
                    rawName: STORE.draft.data.rawName,
                    categoria: STORE.draft.data.categoria,
                    pista: STORE.draft.data.pista,
                    type: type
                };

                const val = (id) => { const el = document.getElementById(id); return el ? el.value.trim() : ""; };

                if (type === 'text') base.texto = val('f-texto');
                if (type === 'audio') { const f = val('f-audio'); base.audio = f ? PATHS.AUDIO + f : ""; }
                if (type === 'image') { const f = val('f-imagen'); base.imagen = f ? PATHS.IMAGE + f : ""; }
                if (type === 'image_audio') {
                    const i = val('f-imagen'); const a = val('f-audio');
                    base.imagen = i ? PATHS.IMAGE + i : ""; base.audio = a ? PATHS.AUDIO + a : "";
                }
                if (type === 'video') {
                    base.texto = val('f-texto');
                    const rawUrl = val('f-video');
                    base.videoEmbed = rawUrl.includes('embed') ? rawUrl : (UTILS.convertToEmbed(rawUrl) || "");
                }
                if (type === 'internal') base.archivo = val('f-archivo');
                if (type === 'link') base.link = val('f-link');
                if (type === 'download') {
                    const n = val('f-dl-nombre');
                    base.descarga = { url: n ? PATHS.ENCRYPTED + n : "", nombre: n };
                }
                return base;
            },

            // UX & A11Y MEJORA: Modal Genérico con Focus Trap
            openModal(title, msg, onConfirm) {
                const m = this.els.modal;
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = msg;
                
                // Save current focus to restore later
                this.lastFocusedElement = document.activeElement;

                // Setup buttons
                const btnConfirm = document.getElementById('modal-btn-confirm');
                const btnCancel = document.getElementById('modal-btn-cancel');

                btnConfirm.onclick = () => { onConfirm(); this.closeModal(); };
                btnCancel.onclick = () => this.closeModal();

                m.classList.remove('hidden');
                m.setAttribute('aria-hidden', 'false');

                // Focus Trap
                setTimeout(() => btnCancel.focus(), 50);

                // Trap event listener
                m.addEventListener('keydown', this.handleTabKey);
            },

            closeModal() {
                const m = this.els.modal;
                m.classList.add('hidden');
                m.setAttribute('aria-hidden', 'true');
                m.removeEventListener('keydown', this.handleTabKey);
                
                // Restore focus
                if (this.lastFocusedElement) this.lastFocusedElement.focus();
            },

            handleTabKey(e) {
                const modal = document.getElementById('generic-modal');
                if (e.key === 'Tab') {
                    const focusable = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    const first = focusable[0];
                    const last = focusable[focusable.length - 1];

                    if (e.shiftKey) { 
                        if (document.activeElement === first) {
                            e.preventDefault();
                            last.focus();
                        }
                    } else {
                        if (document.activeElement === last) {
                            e.preventDefault();
                            first.focus();
                        }
                    }
                }
                if (e.key === 'Escape') {
                    UI.closeModal();
                }
            }
        };

        const APP = {
            initEmpty: () => { STORE.init(); UI.showEditor(); },
            handleFileUpload: (input) => {
                const f = input.files[0]; if (!f) return;
                const r = new FileReader();
                r.onload = (e) => {
                    try {
                        const p = IO.parse(e.target.result);
                        STORE.init(p.mensajes, p.logros, p.herramientas);
                        UI.showEditor();
                        UTILS.showToast("Cargado correctamente");
                    } catch(err) { UTILS.showToast("Error al cargar", "error"); console.error(err); }
                };
                r.readAsText(f);
            },
            createNew: () => { STORE.createDraft(); UI.renderList(); },
            editMessage: (id) => { STORE.startDraft(id); UI.renderList(); },
            
            syncStaticField: (field, value) => {
                if (!STORE.draft) return;
                STORE.draft.data[field] = value;
                if (field === 'rawName') {
                    document.getElementById('preview-id').innerText = UTILS.normalizeId(value) || "...";
                    UI.els.breadcrumb.textContent = ` > ${value || "Nuevo"}`;
                }
            },

            attemptTypeChange: (newType) => {
                const draft = STORE.draft;
                if (!draft) return;
                const d = draft.data;
                const hasData = (d.texto && d.texto.trim()) || (d.audio && d.audio.trim()) || (d.imagen && d.imagen.trim()) || (d.videoEmbed && d.videoEmbed.trim()) || (d.descarga && d.descarga.nombre);

                if (hasData) {
                    STORE.pendingTypeChange = newType;
                    UI.openModal(
                        "¿Cambiar tipo de recuerdo?",
                        "Si cambias el tipo ahora, perderás el contenido de los campos específicos.",
                        () => APP.confirmTypeChange()
                    );
                } else {
                    APP.confirmTypeChange(newType);
                }
            },

            confirmTypeChange: (forcedType = null) => {
                const newType = forcedType || STORE.pendingTypeChange;
                const draft = STORE.draft;
                if (!draft) return;

                draft.data = {
                    rawName: draft.data.rawName,
                    categoria: draft.data.categoria,
                    pista: draft.data.pista,
                    type: newType,
                    texto: "", audio: "", imagen: "", videoEmbed: "", archivo: "", link: "", descarga: {url:"", nombre:""}
                };
                STORE.pendingTypeChange = null;
                UI.loadForm(draft.data);
            },

            saveDraft: () => {
                const data = UI.getFullFormDataFromDOM();
                const check = VALIDATOR.validate(data);
                
                if (!check.valid) {
                    const errEl = document.getElementById('validation-msg');
                    const errText = errEl.querySelector('span');
                    errText.textContent = check.msg;
                    errEl.style.opacity = '1';
                    
                    const btn = document.getElementById('btn-save'); 
                    if(btn) btn.classList.add('bg-red-800');
                    setTimeout(() => {
                        if(btn) btn.classList.remove('bg-red-800');
                        errEl.style.opacity = '0';
                    }, 4000);

                    // UX MEJORA: Focus automático al error
                    if (check.field) {
                        const badInput = document.getElementById(check.field);
                        if (badInput) {
                            badInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            badInput.focus();
                        }
                    }
                    return;
                }

                const res = STORE.saveDraft(data);
                if (res.success) UTILS.showToast("Guardado correctamente");
                else UTILS.showToast(res.msg, "error");
            },

            // UX MEJORA: Modal propio para delete
            requestDelete: () => {
                UI.openModal(
                    "¿Eliminar recuerdo?",
                    "Esta acción no se puede deshacer.",
                    () => {
                        if (STORE.draft.originalId) STORE.deleteMessage(STORE.draft.originalId);
                        else { STORE.draft = null; UI.hideForm(); }
                    }
                );
            },

            exportData: () => {
                if (STORE.state.mensajes.size === 0) { UTILS.showToast("Nada que exportar", "error"); return; }
                if (STORE.draft) {
                    UTILS.showToast("Guarda o cierra el borrador primero.", "error");
                    return;
                }
                for (let [id, msg] of STORE.state.mensajes) {
                    const check = VALIDATOR.validate(msg);
                    if (!check.valid) {
                        UTILS.showToast(`Error en "${msg.rawName}": ${check.msg}`, "error");
                        APP.editMessage(id);
                        return;
                    }
                }
                try {
                    const blob = new Blob([IO.serialize()], {type: "text/javascript"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = "data.js";
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    UTILS.showToast("Exportado data.js");
                } catch(e) { console.error(e); UTILS.showToast("Error exportando", "error"); }
            },

            toggleTheme: () => {
                const isDark = document.documentElement.classList.toggle('dark');
                const iconContainer = document.getElementById('theme-icon-container');
                iconContainer.innerHTML = isDark ? ICONS.sun : ICONS.moon;
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            },

            initTheme: () => {
                const stored = localStorage.getItem('theme');
                const iconContainer = document.getElementById('theme-icon-container');
                if (stored === 'light') {
                    document.documentElement.classList.remove('dark');
                    iconContainer.innerHTML = ICONS.moon;
                } else {
                    document.documentElement.classList.add('dark');
                    iconContainer.innerHTML = ICONS.sun;
                }
            }
        };

        APP.initTheme();
        window.onbeforeunload = () => STORE.state.mensajes.size > 0 ? "Cambios sin guardar" : null;
    </script>
</body>
</html>
