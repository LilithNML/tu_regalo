<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Recuerdos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 h-screen overflow-hidden flex flex-col transition-colors duration-200">

    <!-- HEADER -->
    <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 h-16 flex items-center justify-between px-6 flex-shrink-0 z-10 shadow-sm transition-colors duration-200">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-violet-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-violet-200 dark:shadow-none">
                <i class="fas fa-heart"></i>
            </div>
            <h1 class="font-bold text-lg text-gray-700 dark:text-gray-200 tracking-tight">Gestor de Recuerdos</h1>
        </div>
        <div class="flex gap-3 items-center">
            <!-- Theme Toggle -->
            <button onclick="APP.toggleTheme()" class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" title="Cambiar tema">
                <i id="theme-icon" class="fas fa-sun"></i>
            </button>
            
            <div id="header-actions" class="hidden flex gap-3">
                <button onclick="APP.exportData()" class="bg-gray-900 dark:bg-violet-700 hover:bg-black dark:hover:bg-violet-600 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-md">
                    <i class="fas fa-file-export"></i> Exportar data.js
                </button>
            </div>
        </div>
    </header>

    <!-- PANTALLA 1: INICIO -->
    <div id="screen-home" class="flex-1 flex flex-col items-center justify-center p-6 fade-in">
        <div class="max-w-md w-full text-center space-y-8">
            <div class="space-y-2">
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Bienvenido</h2>
                <p class="text-gray-500 dark:text-gray-400">Todo listo para crear tus códigos.</p>
            </div>
            
            <div class="grid gap-4">
                <button onclick="APP.initEmpty()" class="group relative flex items-center justify-center p-6 bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700 hover:border-violet-100 dark:hover:border-violet-900 rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer text-left w-full">
                    <div class="flex flex-col items-center gap-3">
                        <div class="w-12 h-12 bg-violet-50 dark:bg-violet-900/30 text-violet-600 dark:text-violet-400 rounded-full flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                            <i class="fas fa-plus"></i>
                        </div>
                        <span class="font-medium text-gray-700 dark:text-gray-200">Crear desde cero</span>
                    </div>
                </button>

                <div class="relative">
                    <input type="file" id="file-upload" accept=".js" class="hidden" onchange="APP.handleFileUpload(this)">
                    <button onclick="document.getElementById('file-upload').click()" class="w-full group relative flex items-center justify-center p-6 bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700 hover:border-violet-100 dark:hover:border-violet-900 rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer">
                        <div class="flex flex-col items-center gap-3">
                            <div class="w-12 h-12 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                                <i class="fas fa-folder-open"></i>
                            </div>
                            <span class="font-medium text-gray-700 dark:text-gray-200">Cargar data.js existente</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PANTALLA 2: EDITOR -->
    <div id="screen-editor" class="hidden flex-1 flex overflow-hidden fade-in">
        
        <!-- SIDEBAR -->
        <aside class="w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col flex-shrink-0 z-20 transition-colors duration-200">
            <div class="p-4 border-b border-gray-100 dark:border-gray-700">
                <button onclick="APP.createNew()" class="w-full bg-violet-600 hover:bg-violet-700 text-white py-3 px-4 rounded-lg text-sm font-bold transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2 transform active:scale-95">
                    <i class="fas fa-plus"></i> Nuevo Recuerdo
                </button>
            </div>
            
            <div id="message-list" class="flex-1 overflow-y-auto p-2 space-y-1 no-scrollbar bg-gray-50/50 dark:bg-gray-900/50">
                <!-- Lista dinámica -->
            </div>
            
            <div class="p-3 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 text-xs text-center text-gray-400 dark:text-gray-500 font-medium transition-colors duration-200" id="counter-display">
                0 recuerdos
            </div>
        </aside>

        <!-- MAIN FORM -->
        <main class="flex-1 bg-gray-50 dark:bg-gray-900 flex flex-col h-full overflow-hidden relative transition-colors duration-200">
            
            <!-- EMPTY STATE -->
            <div id="editor-empty" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 dark:text-gray-500 p-8 select-none">
                <div class="w-20 h-20 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4 text-gray-300 dark:text-gray-600 transition-colors duration-200">
                    <i class="fas fa-pencil-alt text-3xl"></i>
                </div>
                <p class="font-medium">Selecciona un recuerdo o crea uno nuevo</p>
            </div>

            <!-- FORMULARIO -->
            <div id="editor-form-container" class="hidden flex-col h-full max-w-3xl mx-auto w-full bg-white dark:bg-gray-800 shadow-2xl border-x border-gray-200 dark:border-gray-700 transition-colors duration-200">
                
                <!-- Toolbar -->
                <div class="h-14 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between px-8 bg-white dark:bg-gray-800 flex-shrink-0 transition-colors duration-200">
                    <div class="flex items-center gap-2 text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">
                        <i class="fas fa-edit"></i> Editando
                    </div>
                    <button onclick="APP.deleteCurrent()" class="text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-1.5 rounded text-sm transition-colors flex items-center gap-2" title="Eliminar">
                        <i class="fas fa-trash"></i> <span class="hidden sm:inline">Eliminar</span>
                    </button>
                </div>

                <!-- Scroll Area -->
                <div class="flex-1 overflow-y-auto p-8 space-y-8">
                    
                    <!-- NOMBRE -->
                    <div class="space-y-4">
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300">Nombre del recuerdo</label>
                        <input type="text" id="input-rawName" placeholder="Ej: Isla Corazón" 
                               class="w-full text-xl font-medium border-b-2 border-gray-200 dark:border-gray-600 focus:border-violet-500 bg-transparent py-2 px-1 transition-colors placeholder-gray-300 dark:placeholder-gray-600 text-gray-900 dark:text-white"
                               autocomplete="off"
                               oninput="APP.syncStaticField('rawName', this.value)">
                        
                        <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-900 p-2.5 rounded border border-gray-100 dark:border-gray-700 transition-colors duration-200">
                            <i class="fas fa-database text-violet-400"></i>
                            <span>ID de sistema:</span>
                            <code id="preview-id" class="text-violet-600 dark:text-violet-400 font-mono font-bold select-all">...</code>
                        </div>
                    </div>

                    <!-- TIPO Y CATEGORÍA -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300">Tipo de experiencia</label>
                            <div class="relative">
                                <select id="input-type" onchange="APP.attemptTypeChange(this.value)" 
                                        class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 py-3 px-4 rounded-lg appearance-none cursor-pointer hover:border-violet-400 transition-colors focus:ring-2 focus:ring-violet-100 dark:focus:ring-violet-900 font-medium">
                                    <option value="text">Carta</option>
                                    <option value="image">Imagen</option>
                                    <option value="audio">Audio</option>
                                    <option value="image_audio">Imagen + Audio</option>
                                    <option value="video">Video YouTube</option>
                                    <option value="internal">Iframe</option>
                                    <option value="link">Enlace Web</option>
                                    <option value="download">Descarga</option>
                                </select>
                                <div class="absolute right-4 top-3.5 text-gray-400 pointer-events-none">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300">Categoría</label>
                            <input type="text" id="input-categoria" placeholder="Ej: Carta, Regalo, Dedicatoria" 
                                   class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 py-3 px-4 rounded-lg focus:border-violet-500 focus:ring-2 focus:ring-violet-100 dark:focus:ring-violet-900 transition-all placeholder-gray-400 dark:placeholder-gray-500"
                                   oninput="APP.syncStaticField('categoria', this.value)">
                        </div>
                    </div>

                    <!-- CAMPOS DINÁMICOS -->
                    <div id="dynamic-fields" class="space-y-6 border-t border-gray-100 dark:border-gray-700 pt-6 animate-pulse-short">
                        <!-- JS inyecta aquí según draft.type -->
                    </div>

                    <!-- PISTA -->
                    <div class="space-y-2 pt-2">
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300">Pista para desbloquear</label>
                        <div class="flex gap-3 items-start">
                            <div class="mt-3 text-yellow-500 text-lg"><i class="fas fa-lightbulb"></i></div>
                            <textarea id="input-pista" rows="2" placeholder="Escribe algo misterioso..." 
                                      class="w-full bg-yellow-50/50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 text-gray-700 dark:text-gray-200 py-3 px-4 rounded-lg resize-none focus:bg-white dark:focus:bg-gray-700 focus:border-yellow-400 transition-colors placeholder-gray-400 dark:placeholder-gray-500"
                                      oninput="APP.syncStaticField('pista', this.value)"></textarea>
                        </div>
                    </div>

                </div>

                <!-- FOOTER -->
                <div class="p-6 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center flex-shrink-0 transition-colors duration-200">
                    <span id="validation-msg" class="text-xs font-medium text-red-500 opacity-0 transition-opacity">
                        <i class="fas fa-exclamation-circle"></i> Faltan datos requeridos
                    </span>
                    <button onclick="APP.saveDraft()" class="bg-gray-900 dark:bg-violet-600 hover:bg-black dark:hover:bg-violet-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg shadow-gray-300 dark:shadow-none transition-all transform active:scale-95 flex items-center gap-2">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL CONFIRMACIÓN -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100 border border-gray-200 dark:border-gray-700">
            <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900/30 text-orange-500 rounded-full flex items-center justify-center mb-4 text-xl mx-auto">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="text-lg font-bold text-center text-gray-900 dark:text-white mb-2">¿Cambiar tipo de recuerdo?</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 text-center mb-6">
                Si cambias el tipo ahora, perderás el contenido de los campos específicos (texto, imágenes, etc).
            </p>
            <div class="flex gap-3">
                <button onclick="APP.cancelTypeChange()" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 font-medium transition-colors">
                    Cancelar
                </button>
                <button onclick="APP.confirmTypeChange()" class="flex-1 px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-medium transition-colors">
                    Sí, cambiar
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <script>
        const PATHS = {
            AUDIO: "assets/unlocked_content/audio/",
            IMAGE: "assets/unlocked_content/images/",
            ENCRYPTED: "assets/unlocked_content/encrypted/",
            INTERNAL: ""
        };

        const DEFAULTS = {
            LOGROS: `export const logros = [
  { id: "primer_paso", codigo_requerido: 1, mensaje: "Hay muchos más esperándote." },
  { id: "cinco_secretos", codigo_requerido: 5, mensaje: "Eres una gran exploradora." },
  { id: "diez_secretos", codigo_requerido: 10, mensaje: "Tu curiosidad no tiene límites." },
  { id: "veinte_secretos", codigo_requerido: 20, mensaje: "Estás descubriendo todo mi mundo." },
  { id: "mitad_camino", codigo_requerido: 40, mensaje: "Tantos recuerdos desbloqueados..." },
  { id: "casi_todo", codigo_requerido: 70, mensaje: "¡Wow! Eres experta en descubrir mis secretos." },
  { id: "todos_los_secretos", codigo_requerido: "ALL_MESSAGES_LENGTH", mensaje: "¡Todos los secretos desbloqueados!." }
];`,
            HERRAMIENTAS: `export const herramientasExternas = [
  { nombre: "Desencriptar", descripcion: "Herramienta web para desencriptar imágenes de forma rápida.", url: "https://lilithnml.github.io/te_amo/webcrypto/", icono: "fas fa-key" }
];`
        };

        const UTILS = {
            normalizeId: (str) => {
                if (!str) return "";
                return str.toLowerCase()
                          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                          .replace(/\s+/g, "")
                          .replace(/[^a-z0-9]/g, "");
            },
            extractFilename: (fullPath) => fullPath ? fullPath.split('/').pop() : "",
            convertToEmbed: (url) => {
                if (!url) return "";
                const regExp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = url.match(regExp);
                return (match && match[1]) ? `https://www.youtube.com/embed/${match[1]}` : null;
            },
            showToast: (msg, type = 'success') => {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-500' : 'bg-gray-900 dark:bg-violet-600';
                el.className = `${colors} text-white px-5 py-3 rounded-lg shadow-xl text-sm font-medium fade-in pointer-events-auto flex items-center gap-3 transform transition-all`;
                el.innerHTML = type === 'error' 
                    ? `<i class="fas fa-times-circle text-lg"></i> <span>${msg}</span>` 
                    : `<i class="fas fa-check-circle text-lg text-green-400"></i> <span>${msg}</span>`;
                container.appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(10px)';
                    setTimeout(() => el.remove(), 300);
                }, 3500);
            },
            escapeString: (str) => str ? str.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n') : "",
            unescapeString: (str) => str ? str.replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\') : ""
        };

        const STORE = {
            state: {
                mensajes: new Map(),
                rawLogros: DEFAULTS.LOGROS,
                rawHerramientas: DEFAULTS.HERRAMIENTAS
            },
            draft: null, 
            pendingTypeChange: null,

            init(mensajesObj = {}, rawLogros = null, rawHerramientas = null) {
                this.state.mensajes = new Map(Object.entries(mensajesObj));
                if (rawLogros) this.state.rawLogros = rawLogros;
                if (rawHerramientas) this.state.rawHerramientas = rawHerramientas;
                UI.renderList();
            },

            startDraft(id) {
                const msg = this.state.mensajes.get(id);
                const data = JSON.parse(JSON.stringify(msg));
                if (!data.rawName) data.rawName = id;
                this.draft = { originalId: id, data: data, isNew: false };
                UI.loadForm(this.draft.data);
            },

            createDraft() {
                this.draft = {
                    originalId: null,
                    data: {
                        rawName: "", type: "text", categoria: "", pista: "",
                        texto: "", audio: "", imagen: "", videoEmbed: "", archivo: "", link: "",
                        descarga: { url: "", nombre: "" }
                    },
                    isNew: true
                };
                UI.loadForm(this.draft.data);
            },

            saveDraft(finalData) {
                const newId = UTILS.normalizeId(finalData.rawName);
                if (!newId) return { success: false, msg: "El nombre no genera un ID válido" };

                if (newId !== this.draft.originalId && this.state.mensajes.has(newId)) {
                    return { success: false, msg: "Ya existe un recuerdo con un nombre similar" };
                }

                const cleanData = VALIDATOR.sanitize(finalData);

                if (!this.draft.isNew && this.draft.originalId && newId !== this.draft.originalId) {
                    this.state.mensajes.delete(this.draft.originalId);
                }

                this.state.mensajes.set(newId, cleanData);
                this.draft = null;
                UI.renderList();
                UI.selectItem(newId);
                return { success: true };
            },

            deleteMessage(id) {
                this.state.mensajes.delete(id);
                this.draft = null;
                UI.renderList();
                UI.hideForm();
            }
        };

        const VALIDATOR = {
            validate: (data) => {
                if (!data.rawName || !data.rawName.trim()) return { valid: false, msg: "El nombre es obligatorio." };

                const t = data.type;
                
                if (t === 'text') {
                    if (!data.texto || !data.texto.trim()) return { valid: false, msg: "El texto no puede estar vacío." };
                }
                else if (t === 'image') {
                    if (!data.imagen) return { valid: false, msg: "Debes asignar un nombre de archivo de imagen." };
                }
                else if (t === 'audio') {
                    if (!data.audio) return { valid: false, msg: "Debes asignar un nombre de archivo de audio." };
                }
                else if (t === 'image_audio') {
                    if (!data.imagen || !data.audio) return { valid: false, msg: "Se requiere tanto imagen como audio." };
                }
                else if (t === 'video') {
                    if (!data.videoEmbed) return { valid: false, msg: "No pudimos reconocer este enlace como un video válido de YouTube." };
                }
                else if (t === 'internal') {
                    if (!data.archivo) return { valid: false, msg: "Debes especificar la ruta del archivo interno." };
                }
                else if (t === 'link') {
                    if (!data.link) return { valid: false, msg: "Debes ingresar una URL válida." };
                }
                else if (t === 'download') {
                    if (!data.descarga || !data.descarga.nombre) return { valid: false, msg: "Debes especificar el nombre del archivo a descargar." };
                }

                return { valid: true };
            },

            sanitize: (data) => {
                const base = {
                    type: data.type,
                    categoria: data.categoria || "General",
                    pista: data.pista || "",
                    rawName: data.rawName
                };
                if (data.type === 'text') base.texto = data.texto;
                if (data.type === 'audio') base.audio = data.audio;
                if (data.type === 'image') base.imagen = data.imagen;
                if (data.type === 'image_audio') { base.audio = data.audio; base.imagen = data.imagen; }
                if (data.type === 'video') { base.texto = data.texto; base.videoEmbed = data.videoEmbed; }
                if (data.type === 'internal') base.archivo = data.archivo;
                if (data.type === 'link') base.link = data.link;
                if (data.type === 'download') base.descarga = data.descarga;
                return base;
            }
        };

        const IO = {
            parse: (content) => {
                try {
                    const mensajesRaw = content.match(/export const mensajes = ({[\s\S]*?});/);
                    const logrosRaw = content.match(/export const logros = (\[[\s\S]*?\]);/);
                    const herrRaw = content.match(/export const herramientasExternas = (\[[\s\S]*?\]);/);

                    if (!mensajesRaw) throw new Error("Formato inválido: Falta bloque mensajes");

                    const mensajesObj = {};
                    let rawBody = mensajesRaw[1].trim().substring(1, mensajesRaw[1].trim().length - 1);
                    
                    let remaining = rawBody;
                    let safety = 0;
                    while (remaining.length > 0 && safety < 1000) {
                        safety++;
                        const keyMatch = remaining.match(/^\s*"([^"]+)":\s*\{/);
                        if (!keyMatch) {
                            if (remaining.match(/^\s*,?\s*$/)) break;
                            remaining = remaining.substring(1); continue;
                        }
                        const key = keyMatch[1];
                        const startBrace = remaining.indexOf('{');
                        let balance = 0, endBrace = -1, inStr = false;
                        for (let i = startBrace; i < remaining.length; i++) {
                            if (remaining[i] === '"' && remaining[i-1] !== '\\') inStr = !inStr;
                            if (!inStr) {
                                if (remaining[i] === '{') balance++;
                                if (remaining[i] === '}') balance--;
                                if (balance === 0) { endBrace = i; break; }
                            }
                        }
                        if (endBrace === -1) break;

                        const block = remaining.substring(startBrace, endBrace + 1);
                        mensajesObj[key] = IO.parseBlock(block);
                        mensajesObj[key].rawName = key; 

                        remaining = remaining.substring(endBrace + 1).trim();
                        if (remaining.startsWith(',')) remaining = remaining.substring(1).trim();
                    }

                    return { mensajes: mensajesObj, logros: logrosRaw ? logrosRaw[0] : null, herramientas: herrRaw ? herrRaw[0] : null };
                } catch (e) {
                    console.error(e);
                    throw new Error("Archivo corrupto o ilegible.");
                }
            },
            parseBlock: (str) => {
                const props = {};
                const dlMatch = str.match(/descarga:\s*({[\s\S]*?})(,|$)/);
                if (dlMatch) {
                    const dlBody = dlMatch[1];
                    const url = (dlBody.match(/url:\s*"([^"]*)"/) || [])[1] || "";
                    const nom = (dlBody.match(/nombre:\s*"([^"]*)"/) || [])[1] || "";
                    props.descarga = { url, nombre: nom };
                    str = str.replace(dlMatch[0], "");
                }
                const regex = /([a-zA-Z0-9_]+):\s*"((?:[^"\\]|\\.)*)"/g;
                let m;
                while ((m = regex.exec(str)) !== null) props[m[1]] = UTILS.unescapeString(m[2]);
                return props;
            },
            serialize: () => {
                let js = `export const mensajes = {\n`;
                STORE.state.mensajes.forEach((msg, key) => {
                    js += `  "${key}": {\n    type: "${msg.type}",\n`;
                    if (msg.texto) js += `    texto: "${UTILS.escapeString(msg.texto)}",\n`;
                    if (msg.audio) js += `    audio: "${msg.audio}",\n`;
                    if (msg.imagen) js += `    imagen: "${msg.imagen}",\n`;
                    if (msg.videoEmbed) js += `    videoEmbed: "${msg.videoEmbed}",\n`;
                    if (msg.archivo) js += `    archivo: "${msg.archivo}",\n`;
                    if (msg.link) js += `    link: "${msg.link}",\n`;
                    if (msg.descarga) js += `    descarga: {\n      url: "${msg.descarga.url}",\n      nombre: "${msg.descarga.nombre}"\n    },\n`;
                    js += `    categoria: "${UTILS.escapeString(msg.categoria)}",\n    pista: "${UTILS.escapeString(msg.pista)}"\n  },\n`;
                });
                js += `};\n\n`;
                
                let log = STORE.state.rawLogros.trim();
                if (!log.startsWith('export')) log = `export const logros = ${log};`;
                let herr = STORE.state.rawHerramientas.trim();
                if (!herr.startsWith('export')) herr = `export const herramientasExternas = ${herr};`;
                return js + log + "\n\n" + herr;
            }
        };

        const UI = {
            els: {
                screenHome: document.getElementById('screen-home'),
                screenEditor: document.getElementById('screen-editor'),
                headerActions: document.getElementById('header-actions'),
                list: document.getElementById('message-list'),
                counter: document.getElementById('counter-display'),
                formContainer: document.getElementById('editor-form-container'),
                editorEmpty: document.getElementById('editor-empty'),
                dynamicFields: document.getElementById('dynamic-fields'),
                confirmModal: document.getElementById('confirm-modal'),
                inputRawName: document.getElementById('input-rawName'),
                previewId: document.getElementById('preview-id'),
                inputType: document.getElementById('input-type'),
                inputCat: document.getElementById('input-categoria'),
                inputPista: document.getElementById('input-pista'),
                msgError: document.getElementById('validation-msg')
            },

            showEditor() {
                this.els.screenHome.classList.add('hidden');
                this.els.screenEditor.classList.remove('hidden');
                this.els.screenEditor.classList.add('flex');
                this.els.headerActions.classList.remove('hidden');
            },

            renderList() {
                this.els.list.innerHTML = '';
                const messages = Array.from(STORE.state.mensajes.entries());
                this.els.counter.innerText = `${messages.length} recuerdos guardados`;

                messages.forEach(([id, msg]) => {
                    const el = document.createElement('div');
                    const isActive = STORE.draft && STORE.draft.originalId === id;
                    let icon = 'fa-file-alt';
                    if (msg.type === 'image') icon = 'fa-image';
                    if (msg.type === 'audio') icon = 'fa-music';
                    if (msg.type === 'video') icon = 'fa-play-circle';
                    if (msg.type === 'download') icon = 'fa-gift';

                    // Clases dinámicas para lista
                    const baseClass = "p-3 mx-2 rounded-lg cursor-pointer transition-all border border-transparent";
                    const activeClass = "bg-white dark:bg-gray-700 shadow-md border-violet-100 dark:border-gray-600 ring-1 ring-violet-500 dark:ring-violet-400";
                    const inactiveClass = "hover:bg-white dark:hover:bg-gray-800 hover:shadow-sm";
                    
                    el.className = `${baseClass} ${isActive ? activeClass : inactiveClass}`;
                    el.onclick = () => APP.editMessage(id);
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-gray-50 dark:bg-gray-800 flex items-center justify-center flex-shrink-0 text-sm"><i class="fas ${icon} text-gray-400 dark:text-gray-500"></i></div>
                            <div class="overflow-hidden flex-1">
                                <div class="font-bold text-gray-700 dark:text-gray-200 truncate text-sm">${msg.rawName || id}</div>
                                <div class="text-[10px] text-gray-400 dark:text-gray-500 font-mono">#${id}</div>
                            </div>
                        </div>`;
                    this.els.list.appendChild(el);
                });
            },

            selectItem(id) { this.renderList(); },
            hideForm() { 
                this.els.formContainer.classList.remove('flex');
                this.els.formContainer.classList.add('hidden');
                this.els.editorEmpty.classList.remove('hidden');
            },

            loadForm(data) {
                this.els.editorEmpty.classList.add('hidden');
                this.els.formContainer.classList.remove('hidden');
                this.els.formContainer.classList.add('flex');
                this.els.msgError.style.opacity = '0';

                this.els.inputRawName.value = data.rawName || "";
                this.els.previewId.innerText = UTILS.normalizeId(data.rawName) || "...";
                this.els.inputCat.value = data.categoria || "";
                this.els.inputPista.value = data.pista || "";
                this.els.inputType.value = data.type;

                this.renderDynamicFields(data.type, data);
            },

            renderDynamicFields(type, data) {
                const container = this.els.dynamicFields;
                container.innerHTML = '';
                
                const createInput = (label, id, value, placeholder, help = "", isArea = false) => {
                    const wrap = document.createElement('div');
                    // Clases dinámicas para inputs inyectados
                    const inputClasses = "w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 p-3 rounded-lg focus:ring-2 focus:ring-violet-100 dark:focus:ring-violet-900 focus:border-violet-500 transition-colors placeholder-gray-400 dark:placeholder-gray-500";
                    
                    const inputHtml = isArea
                        ? `<textarea id="${id}" rows="5" class="${inputClasses}">${value || ''}</textarea>`
                        : `<input type="text" id="${id}" value="${value || ''}" placeholder="${placeholder}" class="${inputClasses}">`;
                    
                    wrap.className = "space-y-1";
                    wrap.innerHTML = `<label class="block text-sm font-bold text-gray-700 dark:text-gray-300">${label}</label>${help ? `<p class="text-xs text-gray-400 dark:text-gray-500 mb-2">${help}</p>` : ''}${inputHtml}`;
                    return wrap;
                };

                if (type === 'text') {
                    container.appendChild(createInput('Contenido', 'f-texto', data.texto, 'Escribe aquí...', '', true));
                }
                else if (type === 'audio') {
                    container.appendChild(createInput('Nombre archivo Audio', 'f-audio', UTILS.extractFilename(data.audio), 'ejemplo: audio.mp3', 'Solo nombre. Ruta automática.'));
                }
                else if (type === 'image') {
                    container.appendChild(createInput('Nombre archivo Imagen', 'f-imagen', UTILS.extractFilename(data.imagen), 'ejemplo: foto.jpg', 'Solo nombre. Ruta automática.'));
                }
                else if (type === 'image_audio') {
                    container.appendChild(createInput('Imagen', 'f-imagen', UTILS.extractFilename(data.imagen), 'foto.jpg'));
                    container.appendChild(createInput('Audio', 'f-audio', UTILS.extractFilename(data.audio), 'audio.mp3'));
                }
                else if (type === 'video') {
                    container.appendChild(createInput('Mensaje', 'f-texto', data.texto, 'Mensaje corto'));
                    container.appendChild(createInput('YouTube Link', 'f-video', data.videoEmbed, 'https://youtu.be/...', 'Convertimos el link automáticamente.'));
                }
                else if (type === 'internal') {
                    container.appendChild(createInput('Ruta Archivo', 'f-archivo', data.archivo, 'folder/index.html'));
                }
                else if (type === 'link') {
                    container.appendChild(createInput('Enlace', 'f-link', data.link, 'https://...'));
                }
                else if (type === 'download') {
                    container.appendChild(createInput('Nombre Archivo Secreto', 'f-dl-nombre', data.descarga ? data.descarga.nombre : "", 'archivo.zip'));
                }
            },

            getFullFormDataFromDOM() {
                const type = STORE.draft.data.type;
                const base = {
                    rawName: STORE.draft.data.rawName,
                    categoria: STORE.draft.data.categoria,
                    pista: STORE.draft.data.pista,
                    type: type
                };

                const val = (id) => { const el = document.getElementById(id); return el ? el.value.trim() : ""; };

                if (type === 'text') base.texto = val('f-texto');
                if (type === 'audio') { const f = val('f-audio'); base.audio = f ? PATHS.AUDIO + f : ""; }
                if (type === 'image') { const f = val('f-imagen'); base.imagen = f ? PATHS.IMAGE + f : ""; }
                if (type === 'image_audio') {
                    const i = val('f-imagen'); const a = val('f-audio');
                    base.imagen = i ? PATHS.IMAGE + i : ""; base.audio = a ? PATHS.AUDIO + a : "";
                }
                if (type === 'video') {
                    base.texto = val('f-texto');
                    const rawUrl = val('f-video');
                    base.videoEmbed = rawUrl.includes('embed') ? rawUrl : (UTILS.convertToEmbed(rawUrl) || "");
                }
                if (type === 'internal') base.archivo = val('f-archivo');
                if (type === 'link') base.link = val('f-link');
                if (type === 'download') {
                    const n = val('f-dl-nombre');
                    base.descarga = { url: n ? PATHS.ENCRYPTED + n : "", nombre: n };
                }
                return base;
            },

            toggleModal(show) {
                if (show) this.els.confirmModal.classList.remove('hidden');
                else this.els.confirmModal.classList.add('hidden');
            }
        };

        const APP = {
            initEmpty: () => { STORE.init(); UI.showEditor(); },
            handleFileUpload: (input) => {
                const f = input.files[0]; if (!f) return;
                const r = new FileReader();
                r.onload = (e) => {
                    try {
                        const p = IO.parse(e.target.result);
                        STORE.init(p.mensajes, p.logros, p.herramientas);
                        UI.showEditor();
                        UTILS.showToast("Cargado correctamente");
                    } catch(err) { UTILS.showToast("Error al cargar", "error"); console.error(err); }
                };
                r.readAsText(f);
            },
            createNew: () => { STORE.createDraft(); UI.renderList(); },
            editMessage: (id) => { STORE.startDraft(id); UI.renderList(); },
            
            syncStaticField: (field, value) => {
                if (!STORE.draft) return;
                STORE.draft.data[field] = value;
                if (field === 'rawName') {
                    document.getElementById('preview-id').innerText = UTILS.normalizeId(value) || "...";
                }
            },

            attemptTypeChange: (newType) => {
                const draft = STORE.draft;
                if (!draft) return;

                const d = draft.data;
                const hasData = (d.texto && d.texto.trim()) || 
                                (d.audio && d.audio.trim()) || 
                                (d.imagen && d.imagen.trim()) || 
                                (d.videoEmbed && d.videoEmbed.trim()) || 
                                (d.descarga && d.descarga.nombre);

                if (hasData) {
                    STORE.pendingTypeChange = newType;
                    UI.toggleModal(true);
                } else {
                    APP.confirmTypeChange(newType);
                }
            },

            confirmTypeChange: (forcedType = null) => {
                const newType = forcedType || STORE.pendingTypeChange;
                const draft = STORE.draft;
                if (!draft) return;

                draft.data = {
                    rawName: draft.data.rawName,
                    categoria: draft.data.categoria,
                    pista: draft.data.pista,
                    type: newType,
                    texto: "", audio: "", imagen: "", videoEmbed: "", archivo: "", link: "", descarga: {url:"", nombre:""}
                };

                STORE.pendingTypeChange = null;
                UI.toggleModal(false);
                UI.loadForm(draft.data);
            },

            cancelTypeChange: () => {
                const draft = STORE.draft;
                UI.toggleModal(false);
                document.getElementById('input-type').value = draft.data.type;
            },

            saveDraft: () => {
                const data = UI.getFullFormDataFromDOM();
                const check = VALIDATOR.validate(data);
                
                if (!check.valid) {
                    const errEl = document.getElementById('validation-msg');
                    errEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${check.msg}`;
                    errEl.style.opacity = '1';
                    const btn = document.querySelector('button i.fa-save').parentElement;
                    btn.classList.add('bg-red-800');
                    setTimeout(() => {
                        btn.classList.remove('bg-red-800');
                        errEl.style.opacity = '0';
                    }, 4000);
                    return;
                }

                const res = STORE.saveDraft(data);
                if (res.success) UTILS.showToast("Guardado correctamente");
                else UTILS.showToast(res.msg, "error");
            },

            deleteCurrent: () => {
                if (confirm("¿Eliminar?")) {
                    if (STORE.draft.originalId) STORE.deleteMessage(STORE.draft.originalId);
                    else { STORE.draft = null; UI.hideForm(); }
                }
            },

            exportData: () => {
                if (STORE.state.mensajes.size === 0) { UTILS.showToast("Nada que exportar", "error"); return; }
                
                if (STORE.draft) {
                    UTILS.showToast("Por favor guarda o cierra el borrador actual antes de exportar.", "error");
                    return;
                }

                for (let [id, msg] of STORE.state.mensajes) {
                    const check = VALIDATOR.validate(msg);
                    if (!check.valid) {
                        UTILS.showToast(`Error en "${msg.rawName}": ${check.msg}`, "error");
                        APP.editMessage(id);
                        return;
                    }
                }

                try {
                    const blob = new Blob([IO.serialize()], {type: "text/javascript"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = "data.js";
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    UTILS.showToast("Exportado data.js (Validado)");
                } catch(e) { console.error(e); UTILS.showToast("Error técnico exportando", "error"); }
            },

            // THEME LOGIC
            toggleTheme: () => {
                const isDark = document.documentElement.classList.toggle('dark');
                const icon = document.getElementById('theme-icon');
                if (isDark) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    localStorage.setItem('theme', 'dark');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    localStorage.setItem('theme', 'light');
                }
            },

            initTheme: () => {
                // Default Dark
                const stored = localStorage.getItem('theme');
                if (stored === 'light') {
                    document.documentElement.classList.remove('dark');
                    const icon = document.getElementById('theme-icon');
                    if(icon) {
                        icon.classList.remove('fa-sun');
                        icon.classList.add('fa-moon');
                    }
                } else {
                    // Si es null o dark, nos aseguramos que esté en dark
                    document.documentElement.classList.add('dark');
                }
            }
        };

        // Inicializar tema al cargar
        APP.initTheme();

        window.onbeforeunload = () => STORE.state.mensajes.size > 0 ? "Cambios sin guardar" : null;
    </script>
</body>
</html>
